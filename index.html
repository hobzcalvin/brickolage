<html>
<head>
  <script src="js/p5.js"></script>
  <script src="js/opc.js"></script>

  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-touch-fullscreen" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style type="text/css">
  </style>
</head>
<body bgcolor="black">

<script>
/*
 For testing, do:
 /path/to/this-file> python -m SimpleHTTPServer 8000
 /path/to/websockify> ./websockify.py 7890 localhost:7891
 /path/to/openpixelcontrol> bin/gl_server -l layouts/mylayout.json -p 7891
 */

// Set true if using websockify, which expects a format slightly different
// from the fcserver
var WEBSOCKIFY = true;
var OPC_HOST = window.location.hostname + ':7890';

var HEIGHT = 10;
var WIDTH = 40;
var DIAMETER = 30;
var COLOR_SPEED = 5000;

var lastFrame;

function setup() {
  pixelDensity(1);
  createCanvas(windowWidth, windowHeight);
  opc = new p5.OPC(OPC_HOST, WEBSOCKIFY);
  setupGrid();

  colorMode(HSB, COLOR_SPEED, 1, 1);
  strokeWeight(DIAMETER);
  fill(0, 0, 1);
  tint(0, 0, 0.9);
}
function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
  setupGrid();
}
function setupGrid() {
  for (var i = 0; i < 8; i++) {
    opc.ledGrid(i*50, HEIGHT, 5, width * (0.5 + i) / 8, height/2, width/WIDTH, width/WIDTH, 3*Math.PI/2, true, true);
  }
  background(0);
  lastFrame = get();
}

var touchHistory = {};

function draw() {
  // Tint is applied so this will fade the image slowly
  image(lastFrame);
 
  for (var i in touchHistory) {
    var touch = touchHistory[i];
    if (touch.length > 1) {
      // Color is stored in the last (earliest) history element.
      stroke(touch[touch.length-1].color);
      for (var j = 0; j < touch.length-1; j++) {
        if (!touch[j].handled) {
          line(touch[j].x, touch[j].y, touch[j+1].x, touch[j+1].y);
          touch[j].handled = true;
        }
      }
    } else {
      noStroke();
      fill(touch[touch.length-1].color);
      ellipse(touch[0].x, touch[0].y, DIAMETER, DIAMETER);
    }
  } 

  // Save the canvas before OPC does crap to it
  lastFrame = get();
  opc.handleDraw();
}

// One-stop function to handle the current state of touches, which if this is
// called, probably changed in some way.
function handleTouches(ts) {
  newTH = {};
  for (var i in ts) {
    var touch = ts[i];
    var record = { t: millis(), x: touch.x, y: touch.y };
    if (touch.id in touchHistory) {
      newTH[touch.id] = [record].concat(touchHistory[touch.id]);
    } else {
      record.color = color(record.t % COLOR_SPEED, 1, 1);
      newTH[touch.id] = [record]
    }
  }
  touchHistory = newTH;
}
// Pressed and tragged are the same thing: update with a faked touches object
mousePressed = mouseDragged = function() {
  handleTouches([{x: mouseX, y: mouseY, id:0}]);
}
// Mouse released means no more (faked) touches
mouseReleased = function() {
  handleTouches([]);
}
// Real touch events can just pass along the touches array
touchStarted = touchMoved = touchEnded = function() {
  handleTouches(touches);
}


// Prevent overscrolling on iOS etc.
document.body.addEventListener('touchmove', function(event) {
  event.preventDefault();
}, false); 

</script>
</body>
</html>
